\section{Angriffe}
Im Rahmen dieser Ausarbeitung wollen wir uns auf die Ermittlung des gemeinsamen \textit{Pre-Shared Key} (folgend PSK) als Angriffsziel und auf den Angriffsvektor des Brechens des PSK durch Exploration des Schlüsselraumes beschränken. 
Tatsächlich gibt es nach dem bekannten Stand der Forschung nur wenige Angriffe auf WPA2 PSK, die starke Vorannahmen über das Netzwerk und deren Teilnehmer treffen weswegen ihre Praxisrelevanz fragwürdig erscheint.
%-- aufgrund der Aufmerksamkeit, der sich dieses Thema unter Netzwerkexperten und Kryptologen in der Vergangenheit erfreute, ist nicht damit zu rechnen, dass in dem Verfahren noch grundlegende Schwachstellen gefunden werden. 
Ein schwach gewähltes Passwort hingegen kann oftmals durch einen durchdachten Wörterbuchangriff in realistischer Zeit gebrochen werden.
%TODO: Stimmt wohl nicht, siehe https://dl.aircrack-ng.org/breakingwepandwpa.pdf Formulierung ist auch sehr gewagt, es kann immer was passieren ;)

Durch die nachfolgend beschriebene "Auskunftsfreudigkeit" der meisten Endgeräte ergeben sich weitere Ansätze zur Ermittlung des PSK. 
So zielt bspw. das Tool Fluxion\footnote{Fluxion ist ein Netzwerk-Tool welches seinen Benutzern erlaubt einen sog. Fake Access Point zu kreieren. Clients, die sich mit diesem Access Point verbinden, werden auf eine manipulierte Kopie der Login-Seite des originalen Access Points weitergeleitet und dazu verleitet, sich erneut mithilfe ihres PSK zu authentifizieren.} auf die Manipulierbarkeit des Nutzers ab~\cite{fluxion}. 
Dieser und weitere praktisch durchführbare Angriffe, wie sie beispielsweise in~\cite{caneill2010attacks} beschrieben sind, sollen in dieser Ausarbeitung jedoch nicht weiter betrachtet werden.

Die Ermittlung des PSKs eines Netzwerkes unterteilt sich in zwei Schritte: 
\begin{enumerate}
	\item Die Erfassung eines WPA2-Handshakes zur Schlüsselaushandlung
	\item Die nachgelagerte Suche nach einem Schlüssel, der zu einer Kollision führen würde
\end{enumerate}
%TODO: Finde die Formulierung von dir oben schon ausreichend, außerdem ist der Footnote Bereich sonst zu groß
%\footnote{Theoretisch könnten auch mehrere potenzielle Schlüssel zu einer Hashkollision führen. Aufgrund der Längenbeschränkung von WPA2-Schlüsseln und der Güte der eingesetzten Hash-Verfahren ist dies jedoch äußerst unwahrscheinlich und in der Praxis nicht von Belang.}

\subsection{Erfassen eines WPA2-Handshakes}
Im Folgenden soll erläutert werden, welche Möglichkeiten ein Angreifer besitzt den für den Bruteforce-Angriff benötigten Handshake zu ermitteln. 
Die wohl subtilste Methode, die dem Angriefer zur Verfügung steht, ist es den Netzwerkverkehr zu überwachen und zu warten, bis sich ein Client an einem Access Point im gewünschten Netzwerk authentifiziert. 
Abhängig von der Netzwerkinfrastruktur und des Verhaltens der Clients kann dies jedoch viel Zeit in Anspruch nehmen.
Folgend werden zwei mögliche Angriffe beschrieben, die durch aktives Eingreifen in den Netzwerkverkehr die Authentifikation der Clients forcieren soll.

\subsubsection{Deauthentication-Angriff}
Wie in Sektion~\ref{Grundlagen} bereits beschrieben definiert 802.11 neben Daten-Frames auch Management-Frames, die der Verwaltung des Netzwerkes dienen.
Diese werden jedoch, anders als Daten-Frames, weder authentifiziert noch verschlüsselt auf dem unsicheren Übertragungsmedium versendet.
Das hat zur Folge, dass ein Angreifer eigene Management-Frames erstellen und im Netzwerk unter einem gefälschten Absender an beliebige Teilnehmer verteilen kann.
Zu dieser Klasse zählen unter anderem die sogenannten Deauthentication-Frames mit denen ein Access-Point oder ein Teilnehmer die Schlüsselneuaushandlung unter erneuter Durchführung eines Handshakes erzwingen kann.
Ein Angreifer kann diese Frames für einen Deauthentication-Angriff verwenden um die darauf folgenden Handshakes abzufangen.
Dafür erstellt er ein Deauthentication-Frame und setzt:
\begin{itemize}
	\item als Zieladresse (DA) die MAC-Adresse des gewünschten Clients
	\item als Quelladresse (SA) die MAC-Adresse des Access-Points
	\item als Basic Service Set Identifier (BSSID) die MAC-Adresse des Access-Points
	\item einen selbst gewählten Reason Code in den Body
\end{itemize}
Alternativ kann der Client als Absender und der Access-Point als Adressat angegeben werden.
Versendet der Angreifer nun den Deauthentication-Frame an den Client wird dieser, getäuscht durch den gefälschten Absender, die aktive Verbindung zum Access Point unterbrechen und eine Neuauthentifizierung anfragen.
Folglich wird ein neuer Handshake vom Client initiiert, der vom Angreifer mitgeschnitten werden kann.

\subsubsection{\enquote{Evil-Twin}-Angriff}
Ein Nachteil des Deauthentication-Angriffs ist, dass sowohl der Client als auch der Access-Point in Reichweite des Angreifers sein müssen (on-site) um den Handshake zwischen beiden abfangen zu können.
Um den PSK eines WPA2-Netzwerks zu Bruteforcen ist jedoch kein vollständiger Handshake notwendig.
Den Angreifer benötigt lediglich folgende Informationen:
\begin{itemize}
	\item SSID des Netzwerkes 
	\item MAC-Adressen der Handshaketeilnehmer
	\item ANonce aus Schritt 1
	\item SNonce inklusive MIC aus Schritt 2
\end{itemize}
Die Parameter, die vom Access-Point übermittelt werden, unterliegen keinerlei Schutz und werden nicht auf Authentizität geprüft.
Der Angreifer kann demnach die ANonce und MAC-Adresse beliebig wählen und den Handshake bis zu Schritt zwei durchführen.
Um die übrigen Parameter zu erhalten (SNonce inklusive MIC) muss der Angreifer dem Client ein authentisches, ihm bekanntes Netzwerk vortäuschen.
Dafür öffnet der Angreifer einen eigenen Access-Point mit der SSID des Zielnetzwerks und passender Konfiguration: den sogenannten Evil-Twin.
Die Konfiguration entspricht einer der folgenden Möglichkeiten: Open, WEP, WPA-PSK, WPA-Enterprise, WPA2-PSK, WPA2-Enterprise.
Der Angreifer rät nun die richtige Konfiguration oder öffnet alternativ mehrere Access-Points die alle Möglichkeiten abdecken.
Ist das Zielnetzwerk bekannt (und somit auch die SSID), so ist der Evil-Twin einsatzbereit und funktionsfähig.

Oft ist jedoch ein konkreter Client Ziel des Angriffs (zum Beispiel Man in the Middle) und die dem Client bekannten Netzwerke sind dem Angreifer verborgen.
In diesem Fall bedient sich der Angreifer der in Sektion~\ref{Einleitung oder so} beschriebenen Probe-Requests, die vom Client kontinuierlich gesendet werden.
Aus diesen kann der Angreifer die SSIDs auslesen und gegebenenfalls mehrere Access-Points öffnen.
Die gesammelten Handshakes dienen als Grundlage für einen Angriff in die Breite: Anstelle komplexere Passwörter als Kandidaten gewählt werden wird nach der \enquote{lowest hanging fruit}, also dem Netzwerk mit dem schwächsten PSK gesucht

\subsection{Handshake Bruteforcing}
Nachdem die notwendigen Schritte des Handshakes erfolgreich abgefangen wurden kann der Angreifer den PSK offline brechen.
Dafür spielt er die Schritte, die Client und Access-Point während dem Handshake durchführen, lokal nach und wählt dabei in jedem Versuch einen neuen Passwortkandidaten.
Folgende Schritte sind dafür nötig:
\begin{enumerate}
	\item Berechne $PMK = PBKDF2(SSID, PSK, 4096)$
	\item Verwende die aufgezeichneten Noncen und berechne damit \\$PMK = PRF(Client-MAC, Access-Point-MAC, SNonce, ANonce, PMK)$
	\item Bilde den MIC über den PMK Kandidaten und vergleiche ihn mit dem aufgezeichneten
	\begin{enumerate}
		\item MICs sind ungleich: gehe zu Schritt 1
		\item MICs sind gleich: Handshake erfolgreich gebrochen
	\end{enumerate}
\end{enumerate}
Den Großteil des Rechenaufwands benötigt das bilden des PMKs in Schritt 1 über 4096 Runden PBKDF2.
Des weiteren können nur selten PMK-Listen vorab generiert werden, da der PMK auch von der SSID des Netzwerkes abhängig ist.


Dabei gibt es zwei populäre Herangehensweisen zum Erfassen eines WPA2-Handshakes (TODO gibt es noch weitere? Literatur als Beleg!): 

Angriff in die Breite ist ein Thema, welches Erik interessiert. Einfaches Einsammeln vieler Handshakes und Vergleichen mit einem einmal berechneten Hash nicht möglich, da Hash eine Nonce enthält und somit Handshake auch bei gleicher Passphrase verschiedene Hashes enthält. Allerdings sind die "verschiedenen Stufen des Bruteforcens" (damit meine ich: Kontextabhängige Passwörter (bspw. (modifizierte) SSID) , Wörterbuch häufiger Passwörter, Kombinieren verschiedener Wörterbucheinträge bzw. Kombinieren mit Zahlen, tatsächliche, systematische Exploration des Suchraumes) unterschiedlich effizient. So dürfte die Wahrscheinlichkeit, dass ein Passwort einem Wort X aus einem Wörterbuch entspricht deutlich höher sein, als dass es einer gänzlich zufälligen Ziffern-/Zeichenfolge y entspricht. Es sollte daher auf die Idee eingegangen werde, sich auf Wörterbuchangriffe zu beschränken, diese jedoch auf eine Vielzahl von Handshakes (ausgehend von einem Endgerät) loszulassen. Üblicherweise dürften die meisten Nutzer sich in der Vergangenheit auch mit WLANs mit schlechten Passwörtern verbunden haben, daher wird nach der "lowest hanging fruit" gesucht. Soll gezielt die Kommunikation mit einem Netzwerk belauscht werden ist dies nicht von Nutzen, für eine Vielzahl anderer Angriffe jedoch durchaus, bspw. für einen MITM-Angriff via Evil-Twin, DNS-Hijacking, ARP-Spoofing etc..